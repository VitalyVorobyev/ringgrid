# DEC-006: Codebook Invariants

**Status:** Active
**Date:** 2025

## Decision

The marker codebook is a compile-time constant with strict mathematical
properties that must be preserved across regeneration.

### Properties (enforced by tests in `marker/codec.rs`)

1. **893 codewords** (`CODEBOOK_N = 893`), each 16-bit.
2. **16-bit sectors** (`CODEBOOK_BITS = 16`).
3. **No rotational symmetry:** no codeword equals any of its 15 non-trivial
   cyclic rotations.
4. **Pairwise rotational uniqueness:** no two distinct codewords share any
   cyclic rotation.
5. **Minimum cyclic Hamming distance ≥ 5** (`CODEBOOK_MIN_CYCLIC_DIST = 5`)
   between all pairs under all rotations.

### Decoding contract

- Matching: brute-force all 893 × 16 rotations, pick lowest Hamming distance.
- Confidence: `clamp(1 − dist/6) × clamp(margin/3)` where
  `margin = second_best_dist − best_dist`.
- Match result includes: `id` (codebook index), `rotation`, `dist`, `margin`,
  `confidence`.

### Generation

- Generated by `tools/gen_codebook.py` — never hand-edit `codebook.rs`.
- Rebuild: `python3 tools/gen_codebook.py --n 893 --seed 1 ... && cargo build`.
- Board layout is runtime JSON (`tools/board/board_spec.json`), also generated
  by Python — never hand-edit.
