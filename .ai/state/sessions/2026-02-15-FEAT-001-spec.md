# Task: FEAT-001: Normalize Marker Center API and Simplify Finalize Flow

- **Type:** feature
- **Priority:** P0
- **Requesting role:** Project Lead
- **Assigned workflow:** feature-development

## Problem Statement

`DetectedMarker.center` currently depends on whether mapper-based detection was used, which makes public API usage error-prone and frame inference implicit. The finalize stage also contains legacy complexity tied to removed H-guided per-marker refinement behavior. We need one explicit result contract:
- `center` is always image-space
- mapper-space center is optional and explicit
- result frame semantics are explicit in `DetectionResult`

This change is intentionally breaking (no compatibility shim) and must remove stale knobs/fields.

## Affected Pipeline Stages

Which of the 13 stages are impacted? List by number and name.

1. [ ] Proposal
2. [ ] Outer Estimate
3. [ ] Outer Fit
4. [ ] Decode
5. [ ] Inner Estimate
6. [ ] Dedup
7. [x] Projective Center (1st pass)
8. [x] Global Filter
9. [x] H-guided Refine
10. [ ] Projective Center (2nd pass)
11. [x] Completion
12. [x] Projective Center (3rd pass)
13. [x] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/detector/marker_build.rs`
- `crates/ringgrid/src/detector/center_correction.rs`
- `crates/ringgrid/src/pipeline/finalize.rs`
- `crates/ringgrid/src/pipeline/result.rs`
- `crates/ringgrid/src/detector/config.rs`
- `crates/ringgrid/src/api.rs`
- `crates/ringgrid/src/lib.rs`

## Public API Impact

- [ ] No API changes
- [x] New public types (list them)
- `DetectionFrame`
- [x] Changed type signatures (list them)
- `DetectedMarker` fields changed: remove `center_projective`, `center_projective_residual`; add `center_mapped`
- `DetectionResult` fields added: `center_frame`, `homography_frame`
- [x] New config fields (list them, must have `Default`)
- None
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [x] `DetectedMarker.center` is always image-space in all detector entry points.
- [x] `DetectedMarker.center_mapped` is `Some` only when mapper-based pass is active, otherwise omitted.
- [x] `center_projective*` fields are removed from public JSON output.
- [x] `DetectionResult.center_frame` and `DetectionResult.homography_frame` are always present and correct.
- [x] `DetectConfig.refine_with_h` is removed and CLI `--no-refine` path is removed.
- [x] Finalize applies projective center once for initial detections and once for completion-added markers only.
- [x] Markers that cannot be mapped from working->image are dropped when mapper path is active.
- [x] `cargo test --workspace --all-features` passes
- [x] `cargo clippy --all-targets --all-features -- -D warnings` clean
- [ ] Synthetic eval metrics: precision >= 0.99, recall >= 0.99, no material regression in center/homography errors vs pre-change baseline

## Accuracy Constraints

- Center error target: no material regression from baseline (image-space center contract)
- Decode success rate: >= 99% on standard synth eval
- Homography reprojection: no material regression vs pre-change baseline

## Performance Constraints

- Latency budget: no significant regression in end-to-end detect path
- Allocation limits: no new per-candidate allocations in fit/decode hot loops

## Python Tooling Changes

- [ ] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [x] Other: update frame-resolution logic in scorer and eval scripts to consume explicit result frame metadata

## Notes

- Breaking API/JSON change is intentional and immediate (no migration shim).
- Homography frame stays `working` in mapper flows by design.
- Advanced geometry fields (`ellipse_*`, `edge_points_*`) remain in existing detector frame semantics.
