# Task: ALGO-001: Unify Duplicated Radial-Estimator Core (Inner/Outer)

- **Type:** algo
- **Priority:** P1
- **Requesting role:** Project Lead
- **Assigned workflow:** algorithm-improvement

## Problem Statement

`ring::inner_estimate` and `ring::outer_estimate` currently reimplement very similar radial-sampling, derivative, aggregation, polarity-selection, and coverage logic. This duplication increases maintenance cost and creates divergence risk when one estimator evolves independently.

The task is to design and implement a shared radial-estimation core with explicit stage-specific policy hooks (inner vs outer gates/hypothesis logic), preserving or improving current accuracy and robustness.

Given current maturity (`v0.1.x`), **public API breakage is allowed** if it materially improves design clarity and maintainability.

## Affected Pipeline Stages

1. [ ] Proposal
2. [x] Outer Estimate
3. [x] Outer Fit
4. [ ] Decode
5. [x] Inner Estimate
6. [ ] Dedup
7. [ ] Projective Center (1st pass)
8. [ ] Global Filter
9. [ ] H-guided Refine
10. [ ] Projective Center (2nd pass)
11. [x] Completion
12. [ ] Projective Center (3rd pass)
13. [ ] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/ring/inner_estimate.rs`
- `crates/ringgrid/src/ring/outer_estimate.rs`
- `crates/ringgrid/src/ring/radial_profile.rs`
- `crates/ringgrid/src/ring/mod.rs`
- `crates/ringgrid/src/detector/inner_fit.rs`
- `crates/ringgrid/src/detector/outer_fit.rs`

## Public API Impact

- [x] No API changes
- [ ] New public types (list them)
- [ ] Changed type signatures (list them)
- [ ] New config fields (list them, must have `Default`)
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [ ] Shared radial-estimator core is introduced and used by both inner and outer estimators.
- [ ] Stage-specific behavior is explicit (policy/gate/hypothesis selection), not encoded as ad-hoc branching inside one giant function.
- [ ] Duplication between `inner_estimate` and `outer_estimate` is materially reduced, with clear module boundaries.
- [ ] Existing estimator tests pass and new regression tests cover both inner and outer paths through the shared core.
- [ ] `cargo test --workspace --all-features` passes.
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [ ] Validation evidence includes:
- `bash tools/run_blur3_benchmark.sh`
- `bash tools/run_reference_benchmark.sh`
- `bash tools/run_distortion_benchmark.sh`

## Accuracy Constraints

- Center error target: no regression beyond `+0.01 px` mean on blur=3 gate vs pre-change baseline.
- Decode success rate: no material precision/recall regression attributable to estimator changes.
- Homography reprojection: investigate/escalate if mean self/vs-GT delta exceeds `+0.02 px`.

## Performance Constraints

- Latency budget: no material regression in estimator-related paths (report before/after on representative benches or profiling data).
- Allocation limits: no new per-theta/per-radius allocation churn in hot loops.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Evidence source for duplication risk:
- `.ai/state/sessions/2026-02-16-lead-code-quality-audit.md`
- If algorithm/API tradeoffs are significant, capture decision in an ADR before full integration.
