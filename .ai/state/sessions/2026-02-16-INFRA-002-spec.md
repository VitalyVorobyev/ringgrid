# Task: INFRA-002: Decompose Self-Undistort into Focused Modules

- **Type:** infra
- **Priority:** P1
- **Requesting role:** Project Lead
- **Assigned workflow:** feature-development

## Problem Statement

`crates/ringgrid/src/pixelmap/self_undistort.rs` currently mixes objective definition, optimization, validation policy, and orchestration in one large module. This violates single-responsibility boundaries, increases review/change risk, and makes correctness reasoning difficult. The task is to split self-undistort into focused components with explicit contracts and clearer API boundaries.

Given current project maturity (`v0.1.0`), **public API breakage is allowed** when it yields a clearer and more maintainable design.

## Affected Pipeline Stages

This task mainly affects detection-mode orchestration around self-undistort, which can trigger full second-pass detection.

1. [x] Proposal
2. [x] Outer Estimate
3. [x] Outer Fit
4. [x] Decode
5. [x] Inner Estimate
6. [x] Dedup
7. [x] Projective Center (1st pass)
8. [x] Global Filter
9. [x] H-guided Refine
10. [x] Projective Center (2nd pass)
11. [x] Completion
12. [x] Projective Center (3rd pass)
13. [x] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/pixelmap/self_undistort.rs`
- `crates/ringgrid/src/pixelmap/mod.rs`
- `crates/ringgrid/src/pipeline/run.rs`
- `crates/ringgrid/src/api.rs`
- `crates/ringgrid/src/lib.rs`
- `crates/ringgrid/src/detector/config.rs` (if config structure changes)

## Public API Impact

- [ ] No API changes
- [x] New public types (list them)
- Potentially strategy/policy/result types for self-undistort decomposition
- [x] Changed type signatures (list them)
- `estimate_self_undistort` and/or `SelfUndistortResult` may be reshaped
- [x] New config fields (list them, must have `Default`)
- If strategy/policy is made explicit
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [ ] Self-undistort logic is split into focused modules (objective, optimizer/search, policy/validation, orchestration glue) with clear internal contracts.
- [ ] No single function in self-undistort path remains a "god function"; complex flows are factored into named units with testable boundaries.
- [ ] Any API break is intentional and documented in a migration section in handoff notes.
- [ ] Existing behavior is preserved or improved on canonical validation gates; any intentional behavior changes are explicitly documented with rationale.
- [ ] `cargo test --workspace --all-features` passes.
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [ ] PERF validation suite evidence included for regression safety:
- `bash tools/run_blur3_benchmark.sh`
- `bash tools/run_reference_benchmark.sh`
- `bash tools/run_distortion_benchmark.sh`

## Accuracy Constraints

- Center error target: no regression beyond `+0.01 px` mean on blur=3 gate versus pre-change baseline.
- Decode success rate: no material regression in precision/recall across the three standard gates.
- Homography reprojection: investigate/escalate if mean self or vs-GT delta exceeds `+0.02 px`.

## Performance Constraints

- Latency budget: no material end-to-end regression on reference benchmark modes; target <= `+5%` unless justified by measured quality gain.
- Allocation limits: avoid introducing new per-marker/per-candidate allocations in hot loops.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Related audit evidence:
- `.ai/state/sessions/2026-02-16-lead-code-quality-audit.md`
- Self-undistort decomposition should preserve frame semantics (`DetectionFrame`, mapper/image center fields).
- If API-level tradeoffs are significant or hard to reverse, author an ADR in `.ai/state/decisions/`.
