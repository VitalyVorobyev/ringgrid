# Task: PERF-004: Optimize Outer-Fit / Outer-Estimate Hotspot Group

- **Type:** perf
- **Priority:** P1
- **Requesting role:** Project Lead
- **Assigned workflow:** performance-optimization

## Problem Statement

After PERF-002 reduced proposal cost, the next largest runtime group is outer-fit/outer-estimate and related radial/edge sampling paths. We need targeted optimization for this stage cluster to improve end-to-end latency, with special attention to mapper-enabled runs where these stages remain costly.

## Affected Pipeline Stages

Which of the 13 stages are impacted? List by number and name.

1. [ ] Proposal
2. [x] Outer Estimate
3. [x] Outer Fit
4. [ ] Decode
5. [ ] Inner Estimate
6. [ ] Dedup
7. [ ] Projective Center (1st pass)
8. [ ] Global Filter
9. [ ] H-guided Refine
10. [ ] Projective Center (2nd pass)
11. [ ] Completion
12. [ ] Projective Center (3rd pass)
13. [ ] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/detector/outer_fit.rs`
- `crates/ringgrid/src/ring/outer_estimate.rs`
- `crates/ringgrid/src/ring/edge_sample.rs`
- `crates/ringgrid/src/ring/radial_profile.rs`
- `crates/ringgrid/benches/hotpaths.rs`

## Public API Impact

- [x] No API changes
- [ ] New public types (list them)
- [ ] Changed type signatures (list them)
- [ ] New config fields (list them, must have `Default`)
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [ ] Added/updated deterministic benchmark coverage for outer-estimate/outer-fit-related operations (new benchmark names documented in handoff).
- [ ] At least one outer-estimate/outer-fit benchmark improves by >=10% versus its PERF-004 baseline.
- [ ] Representative `detect()` flamegraph shows reduction in combined outer-fit/outer-estimate hotspot share versus PERF-001 baseline reference (`~15.28%` outer-fit in non-mapper run), or a written explanation if absolute latency improves while percentage share remains similar.
- [ ] Mapper-enabled profiling is included and improvement/impact is documented.
- [ ] No new per-candidate allocations are introduced in inner loops for outer-estimate/outer-fit critical paths.
- [ ] `cargo test --workspace --all-features` passes.
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [ ] Validation gate is complete with all required runs:
  - `./.venv/bin/python3 tools/run_synth_eval.py --n 10 --blur_px 3.0 --marker_diameter 32.0 --out_dir <...>`
  - `bash tools/run_reference_benchmark.sh`
  - `bash tools/run_distortion_benchmark.sh`

## Accuracy Constraints

- Center error target: mean regression <= +0.01 px versus PERF-002 validated baseline context.
- Decode success rate: no measurable drop beyond deterministic variance on comparison batch.
- Homography reprojection: no material regression (investigate if mean delta > +0.02 px).

## Performance Constraints

- Latency budget: demonstrate measurable outer-fit/outer-estimate stage reduction and report end-to-end impact.
- Allocation limits: do not introduce additional dynamic allocations in per-candidate/per-theta inner loops.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Previous task references:
  - `.ai/state/sessions/2026-02-16-PERF-001-baseline-report.md`
  - `.ai/state/sessions/2026-02-16-PERF-002-performance-handoff.md`
- If optimization requires changing sampling/model semantics (not just implementation), involve Algorithm Engineer with evidence-based handoff.
