# Task: PERF-005: Optimize Inner-Fit Hotspot Group

- **Type:** perf
- **Priority:** P1
- **Requesting role:** Project Lead
- **Assigned workflow:** performance-optimization

## Problem Statement

After PERF-004 improvements to outer-estimate/outer-fit, the next likely performance limiter is inner-fit and its supporting per-theta profile/edge aggregation path, especially in mapper-enabled flows. We need targeted optimization for inner-fit stage hotspots to reduce end-to-end latency while preserving detection quality on strict validation gates.

## Affected Pipeline Stages

Which of the 13 stages are impacted? List by number and name.

1. [ ] Proposal
2. [ ] Outer Estimate
3. [ ] Outer Fit
4. [ ] Decode
5. [x] Inner Estimate
6. [ ] Dedup
7. [ ] Projective Center (1st pass)
8. [ ] Global Filter
9. [ ] H-guided Refine
10. [ ] Projective Center (2nd pass)
11. [ ] Completion
12. [ ] Projective Center (3rd pass)
13. [ ] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/detector/inner_fit.rs`
- `crates/ringgrid/src/ring/inner_estimate.rs`
- `crates/ringgrid/src/ring/radial_profile.rs`
- `crates/ringgrid/src/ring/edge_sample.rs`
- `crates/ringgrid/benches/hotpaths.rs`

## Public API Impact

- [x] No API changes
- [ ] New public types (list them)
- [ ] Changed type signatures (list them)
- [ ] New config fields (list them, must have `Default`)
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [ ] Added/updated deterministic benchmark coverage for inner-fit/inner-estimate operations (benchmark names documented in handoff).
- [ ] At least one inner-fit/inner-estimate benchmark improves by >=10% versus PERF-005 baseline.
- [ ] Representative `detect()` flamegraph shows reduced inner-fit hotspot share versus PERF-001 reference (`~13.89%` non-mapper) and mapper reference (`~22.93%`), or written explanation if absolute latency improves while percentage share remains similar.
- [ ] Mapper-enabled profiling is included and impact is documented.
- [ ] No new per-candidate/per-theta allocations are introduced in optimized inner loops.
- [ ] `cargo test --workspace --all-features` passes.
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [ ] Validation gate is complete with all required runs:
  - `./.venv/bin/python3 tools/run_synth_eval.py --n 10 --blur_px 3.0 --marker_diameter 32.0 --out_dir <...>`
  - `bash tools/run_reference_benchmark.sh`
  - `bash tools/run_distortion_benchmark.sh`

## Accuracy Constraints

- Center error target: mean regression <= +0.01 px versus PERF-004 validated context.
- Decode success rate: no measurable drop beyond deterministic variance on comparison batch.
- Homography reprojection: no material regression (investigate if mean delta > +0.02 px).

## Performance Constraints

- Latency budget: demonstrate measurable inner-fit stage reduction and report end-to-end impact.
- Allocation limits: avoid additional dynamic allocations in per-candidate/per-theta inner loops.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Reference artifacts:
  - `.ai/state/sessions/2026-02-16-PERF-001-baseline-report.md`
  - `.ai/state/sessions/2026-02-16-PERF-004-performance-handoff.md`
- If optimization requires changing model/sampling semantics, involve Algorithm Engineer with evidence-backed handoff.
