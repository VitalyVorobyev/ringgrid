# Task: BUG-001: Fix Decode Config Drift and Expose Hidden Thresholds

- **Type:** bug
- **Priority:** P1
- **Requesting role:** Project Lead
- **Assigned workflow:** bug-fix

## Problem Statement

`DecodeConfig` documentation in `crates/ringgrid/src/marker/decode.rs` currently disagrees with `Default` values (`code_band_ratio`, `samples_per_sector`, `n_radial_rings`, `min_decode_confidence`). In addition, decode behavior still depends on hidden constants (minimum contrast and k-means thresholding iteration/epsilon controls), which are not represented as explicit configuration and not clearly documented as fixed invariants.

This creates user-facing ambiguity in decode tuning and can lead to incorrect assumptions when configuring detector behavior.

## Affected Pipeline Stages

Which of the 10 stages are impacted? List by number and name.

1. [ ] Proposal
2. [ ] Outer Estimate
3. [ ] Outer Fit
4. [x] Decode
5. [ ] Inner Fit
6. [ ] Dedup
7. [ ] Projective Center (once per marker)
8. [ ] Global Filter
9. [x] Completion (+ projective center for new markers)
10. [ ] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/marker/decode.rs`
- `crates/ringgrid/src/detector/config.rs` (if hidden constants are promoted to config fields)
- `crates/ringgrid/src/marker/mod.rs` (if decode config surface or docs require updates)
- `crates/ringgrid/src/detector/outer_fit.rs` (if decode call-site wiring changes)

## Public API Impact

- [ ] No API changes
- [ ] New public types (list them)
- [ ] Changed type signatures (list them)
- [x] New config fields (list them, must have `Default`)
- Potentially decode thresholding controls (for example: minimum contrast and threshold-iteration controls), if chosen instead of fixed invariants.
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [ ] `DecodeConfig` rustdoc values exactly match runtime defaults (single source of truth; no drift).
- [ ] Hidden decode constants are resolved consistently: either exposed as explicit `DecodeConfig` fields (with documented defaults and serde compatibility) or documented as fixed invariants (with rationale and tests).
- [ ] Decode thresholding behavior (contrast gate + iterative threshold convergence controls) is deterministic and covered by unit tests.
- [ ] Regression tests are added/updated for at least default-config decode path, low-contrast rejection behavior, and thresholding-loop convergence guard behavior.
- [ ] `cargo test --workspace --all-features` passes.
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [ ] Synthetic eval metrics remain within thresholds (center-mean delta <= `+0.01 px` vs baseline; no precision/recall regression > `0.005` absolute).

## Accuracy Constraints

- Center error target: no regression beyond `+0.01 px` mean on blur=3 eval versus baseline.
- Decode success rate: no precision/recall regression worse than `-0.005` absolute on standard eval gates.
- Homography reprojection: investigate/escalate if mean self or vs-GT delta exceeds `+0.02 px`.

## Performance Constraints

- Latency budget: no material end-to-end regression; investigate/escalate if key decode-involved runs regress by more than `+5%`.
- Allocation limits: no new per-sector/per-sample allocation churn inside decode loops.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Source evidence: `.ai/state/backlog.md` (`BUG-001` entry) and current drift in `crates/ringgrid/src/marker/decode.rs` docs vs `impl Default`.
- If this introduces new public decode config knobs, request Pipeline Architect API check handoff before close-out (workflow Phase 4 conditional).
