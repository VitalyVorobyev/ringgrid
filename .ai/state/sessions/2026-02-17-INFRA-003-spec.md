# Task: INFRA-003: Replace Stringly Reject Reasons with Typed Enums

- **Type:** infra
- **Priority:** P1
- **Requesting role:** Project Lead
- **Assigned workflow:** feature-development

## Problem Statement

Reject and failure channels in the fit/decode path currently rely on ad hoc `String` values (`Option<String>` and `Result<_, String>`). This makes reject semantics brittle, creates high-cardinality reason variants when numeric values are embedded in text, and weakens compile-time guarantees when reasons are aggregated or forwarded across stages.

This task replaces stringly channels in scoped modules with typed reason enums and stable structured serialization for diagnostics/logging.

## Affected Pipeline Stages

Which of the 10 stages are impacted? List by number and name.

1. [ ] Proposal
2. [ ] Outer Estimate
3. [x] Outer Fit
4. [x] Decode
5. [x] Inner Fit
6. [ ] Dedup
7. [ ] Projective Center (once per marker)
8. [ ] Global Filter
9. [x] Completion (+ projective center for new markers)
10. [ ] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/detector/inner_fit.rs`
- `crates/ringgrid/src/detector/outer_fit.rs`
- `crates/ringgrid/src/detector/completion.rs`
- `crates/ringgrid/src/marker/decode.rs`
- `crates/ringgrid/src/pipeline/fit_decode.rs`
- `crates/ringgrid/src/detector/mod.rs` (if shared reason types are introduced there)

## Public API Impact

- [x] No API changes
- [ ] New public types (list them)
- [ ] Changed type signatures (list them)
- [ ] New config fields (list them, must have `Default`)
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [ ] String-based reject/failure channels in scope are replaced by typed enums (no `Option<String>` or `Result<_, String>` reason channels remain in listed modules).
- [ ] Reject codes used for logs/diagnostics are stable and machine-readable (enum-backed), with deterministic formatting.
- [ ] `pipeline/fit_decode.rs` rejection aggregation is keyed by typed reasons, with stable ordering in summary output.
- [ ] Dynamic numeric context (for example thresholds/observed values) is preserved as separate structured fields or explicit diagnostic payloads rather than embedded free-form text.
- [ ] Unit tests cover representative reject mappings and serialization formatting for new reason enums.
- [ ] `cargo test --workspace --all-features` passes.
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [ ] Synthetic eval metrics remain within thresholds (blur-3 center-mean delta <= `+0.01 px`; no precision/recall regression > `0.005` absolute on required eval suite).

## Accuracy Constraints

- Center error target: no regression beyond `+0.01 px` mean on blur=3 gate versus baseline.
- Decode success rate: precision and recall no worse than `-0.005` absolute on standard gates.
- Homography reprojection: investigate/escalate if mean self or vs-GT delta exceeds `+0.02 px`.

## Performance Constraints

- Latency budget: no material end-to-end regression; investigate/escalate if key benchmark regresses by more than `+5%`.
- Allocation limits: no new per-candidate allocations introduced in fit/decode hot loops.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Source evidence: `.ai/state/sessions/2026-02-16-lead-code-quality-audit.md` (Finding 3).
- This is cross-cutting and potentially hard to reverse; if enum serialization policy affects long-term diagnostics contracts, capture decision in ADR (`.ai/state/decisions/`).
- Keep scope focused on detector/decode/completion reject channels for this task; additional stringly reasons in other domains can be tracked separately.
