# Task: INFRA-004: Deduplicate Homography Correspondence/Stats Utilities

- **Type:** infra
- **Priority:** P2
- **Requesting role:** Project Lead
- **Assigned workflow:** feature-development

## Problem Statement

Homography correspondence collection and reprojection-stat computation logic is currently duplicated across:
- `crates/ringgrid/src/detector/global_filter.rs`
- `crates/ringgrid/src/homography/utils.rs`
- `crates/ringgrid/src/pixelmap/self_undistort/objective.rs`

The duplicated paths implement similar selection, filtering, and summary-stat behaviors with slightly different local conventions. This increases maintenance cost and risks drift in correspondence semantics and error reporting.

This task consolidates shared homography correspondence/stat primitives into a single internal utility layer and rewires current call sites to use it.

## Affected Pipeline Stages

Which of the 10 stages are impacted? List by number and name.

1. [ ] Proposal
2. [ ] Outer Estimate
3. [ ] Outer Fit
4. [ ] Decode
5. [ ] Inner Fit
6. [ ] Dedup
7. [ ] Projective Center (once per marker)
8. [x] Global Filter
9. [ ] Completion (+ projective center for new markers)
10. [x] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/detector/global_filter.rs`
- `crates/ringgrid/src/homography/utils.rs`
- `crates/ringgrid/src/pixelmap/self_undistort/objective.rs`
- `crates/ringgrid/src/homography/` (new shared internal utility module expected)
- `crates/ringgrid/src/homography/mod.rs` (if module wiring changes)

## Public API Impact

- [x] No API changes
- [ ] New public types (list them)
- [ ] Changed type signatures (list them)
- [ ] New config fields (list them, must have `Default`)
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [ ] Shared internal utility functions are introduced for homography correspondences and reprojection stats, and are used by `global_filter`, `homography::utils`, and self-undistort homography-self-error path.
- [ ] Duplicated correspondence/stats logic is materially removed from the three target modules (no behavior-specific copy-paste blocks remain).
- [ ] Frame semantics are explicit at utility boundaries (board mm source frame and image/working destination frame labeling is unambiguous).
- [ ] Existing behavior is preserved: no intentional filtering-policy changes unless documented with rationale and tests.
- [ ] Unit tests cover the shared utilities for representative correspondence edge cases (missing IDs, invalid centers, duplicate IDs/confidence tie handling where applicable).
- [ ] `cargo test --workspace --all-features` passes.
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [ ] Synthetic eval metrics remain within thresholds (center-mean delta <= `+0.01 px`; no precision/recall regression > `0.005` absolute).

## Accuracy Constraints

- Center error target: no regression beyond `+0.01 px` mean on standard synth gate versus baseline.
- Decode success rate: no precision/recall regression worse than `-0.005` absolute.
- Homography reprojection: investigate/escalate if mean self or vs-GT delta exceeds `+0.02 px`.

## Performance Constraints

- Latency budget: no material end-to-end regression; investigate/escalate if key runs regress by more than `+5%`.
- Allocation limits: avoid introducing new per-marker correspondence allocation churn in hot paths.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Source evidence: `.ai/state/sessions/2026-02-16-lead-code-quality-audit.md` (Finding 5).
- Keep utility scope internal (`pub(crate)`), not public API.
- If consolidation forces a non-trivial convention decision (for example duplicate-ID selection policy across frames), capture it in ADR before full rollout.
