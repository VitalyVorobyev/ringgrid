# Task: ALGO-002: Decompose Projective-Center Solver into Testable Stages

- **Type:** algo
- **Priority:** P2
- **Requesting role:** Project Lead
- **Assigned workflow:** algorithm-improvement

## Problem Statement

`ring_center_projective_with_debug` in `crates/ringgrid/src/ring/projective_center.rs` contains multiple responsibilities in one dense routine: conic preparation, eigen-structure analysis, candidate generation, candidate scoring, and winner selection. This increases change risk in math-sensitive code and makes targeted testing/reasoning difficult.

The task is to split the solver into explicit internal stages without changing solver behavior, output semantics, or gating policy.

## Affected Pipeline Stages

Which of the 10 stages are impacted? List by number and name.

1. [ ] Proposal
2. [ ] Outer Estimate
3. [ ] Outer Fit
4. [ ] Decode
5. [ ] Inner Fit
6. [ ] Dedup
7. [x] Projective Center (once per marker)
8. [ ] Global Filter
9. [x] Completion (+ projective center for new markers)
10. [ ] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/ring/projective_center.rs`

## Public API Impact

- [x] No API changes
- [ ] New public types (list them)
- [ ] Changed type signatures (list them)
- [ ] New config fields (list them, must have `Default`)
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [x] `ring_center_projective_with_debug` is decomposed into explicit internal stages for:
- conic preparation + eigenseparation,
- projective point candidate generation,
- candidate scoring,
- candidate selection.
- [x] Existing selector policy and diagnostics semantics (`selected_residual`, `selected_eig_separation`) remain behaviorally consistent.
- [x] Existing projective-center synthetic tests pass unchanged.
- [x] `cargo test --workspace --all-features` passes.
- [x] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [x] Synthetic eval metrics remain within thresholds (center-mean delta <= `+0.01 px`; no precision/recall regression > `0.005` absolute).

## Accuracy Constraints

- Center error target: no regression beyond `+0.01 px` mean on standard synth eval versus baseline.
- Decode success rate: no precision/recall regression worse than `-0.005` absolute.
- Homography reprojection: investigate/escalate if mean self or vs-GT delta exceeds `+0.02 px`.

## Performance Constraints

- Latency budget: no material end-to-end regression; investigate/escalate if runtime regresses by more than `+5%`.
- Allocation limits: no unbounded candidate accumulation growth; keep per-call candidate count bounded by eigen/system/candidate construction.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Frame semantics remain unchanged: recovered centers are in image coordinates, consumed by existing center-correction pipeline.
- Refactor scope intentionally excludes mathematical policy changes.
