# Task: BUG-002: Make Seed Proposal Selection Confidence-Ordered and Deterministic

- **Type:** bug
- **Priority:** P2
- **Requesting role:** Project Lead
- **Assigned workflow:** bug-fix

## Problem Statement

`DetectionResult::seed_proposals` in `crates/ringgrid/src/pipeline/result.rs` currently takes the first `N` markers in iteration order and only then maps them to pass-2 proposals. This means pass-2 seeding is order-dependent rather than policy-driven, and can drop higher-confidence markers when `max_seeds` is active.

We need explicit, deterministic seed ranking so two-pass behavior is reproducible and confidence-prioritized regardless of incidental marker ordering.

## Affected Pipeline Stages

Which of the 10 stages are impacted? List by number and name.

1. [x] Proposal
2. [ ] Outer Estimate
3. [ ] Outer Fit
4. [ ] Decode
5. [ ] Inner Fit
6. [ ] Dedup
7. [ ] Projective Center (once per marker)
8. [ ] Global Filter
9. [ ] Completion (+ projective center for new markers)
10. [ ] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/pipeline/result.rs`
- `crates/ringgrid/src/pipeline/run.rs` (if pass-2 seed wiring needs changes)
- `crates/ringgrid/src/pipeline/mod.rs` (if docs are updated for seed policy)

## Public API Impact

- [x] No API changes
- [ ] New public types (list them)
- [ ] Changed type signatures (list them)
- [ ] New config fields (list them, must have `Default`)
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [ ] `seed_proposals(max_seeds)` selects seeds by explicit confidence-first ranking (not incidental iteration order).
- [ ] A deterministic tie-break policy for equal-confidence markers is implemented and documented in-code.
- [ ] Regression tests verify deterministic output across permuted marker input order for equal-confidence cases.
- [ ] `max_seeds` truncation is applied after ranking and is covered by tests.
- [ ] Non-finite proposal coordinates are rejected consistently and covered by tests.
- [ ] `cargo test --workspace --all-features` passes.
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [ ] Synthetic eval metrics remain within thresholds (center-mean delta <= `+0.01 px`; no precision/recall regression > `0.005` absolute).

## Accuracy Constraints

- Center error target: no regression beyond `+0.01 px` mean on standard synth eval versus baseline.
- Decode success rate: no precision/recall regression worse than `-0.005` absolute.
- Homography reprojection: investigate/escalate if mean self or vs-GT delta exceeds `+0.02 px`.

## Performance Constraints

- Latency budget: no material end-to-end regression; investigate/escalate if pass-level runtime regresses by more than `+5%`.
- Allocation limits: avoid unnecessary extra allocations in per-frame seed selection path.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Source evidence: `.ai/state/sessions/2026-02-16-lead-code-quality-audit.md` (Finding 9), `crates/ringgrid/src/pipeline/result.rs`.
- Keep scope focused on seed ranking determinism for pass-2; do not broaden into seed-merge policy redesign unless required by root cause.
