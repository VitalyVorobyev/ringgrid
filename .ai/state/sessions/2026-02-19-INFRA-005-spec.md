# Task: INFRA-005: Harden BoardLayout Invariants and Loading Errors

- **Type:** infra
- **Priority:** P2
- **Requesting role:** Project Lead
- **Assigned workflow:** feature-development

## Problem Statement

`BoardLayout` currently exposes mutable marker storage (`pub markers`) while using a separate internal ID index (`id_to_idx`) that must be manually rebuilt via `build_index()`. This creates an invariant footgun: external mutation can silently desynchronize lookup behavior.

Board-loading error paths are also weakly typed (`Result<_, String>` internally and `Box<dyn Error>` at public constructor boundaries), which reduces diagnosability and makes precise caller handling difficult.

This task hardens `BoardLayout` invariants and introduces typed board load/validation error contracts.

## Affected Pipeline Stages

Which of the 10 stages are impacted? List by number and name.

1. [ ] Proposal
2. [ ] Outer Estimate
3. [ ] Outer Fit
4. [ ] Decode
5. [ ] Inner Fit
6. [ ] Dedup
7. [ ] Projective Center (once per marker)
8. [x] Global Filter
9. [x] Completion (+ projective center for new markers)
10. [x] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/board_layout.rs`
- `crates/ringgrid/src/api.rs`
- `crates/ringgrid/src/lib.rs` (if new error types are publicly re-exported)
- `crates/ringgrid/src/detector/config.rs` (if constructor wiring requires updates)

## Public API Impact

- [ ] No API changes
- [x] New public types (list them)
- Typed board layout/load error enums (for example `BoardLayoutError` and/or `BoardLayoutLoadError`).
- [x] Changed type signatures (list them)
- `BoardLayout::from_json_file(...)` and detector target-json convenience constructors may return typed errors instead of `Box<dyn Error>`.
- [x] New config fields (list them, must have `Default`)
- Not expected.
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [ ] `BoardLayout` invariants are mutation-safe by API design: external callers cannot leave `id_to_idx` stale (either by making marker internals private or by providing invariant-safe mutation methods).
- [ ] Manual invariant repair (`build_index()` footgun) is removed from normal public usage or clearly confined to internal-only usage with strong guarantees.
- [ ] Board-loading and validation paths use typed errors with machine-matchable variants (schema mismatch, parse failure, invalid dimensions/radii, IO errors, etc.).
- [ ] `Detector::from_target_json_file*` constructors propagate typed board-load errors coherently (no opaque `Box<dyn Error>` at key boundaries unless intentionally wrapped with typed context).
- [ ] Existing behavior is preserved for valid inputs (`BoardLayout::default()`, `xy_mm` lookup, marker counts/geometry).
- [ ] Unit tests cover invariant safety and typed error mapping for representative invalid JSON/spec cases.
- [ ] `cargo test --workspace --all-features` passes.
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [ ] Synthetic eval metrics remain within thresholds (center-mean delta <= `+0.01 px`; no precision/recall regression > `0.005` absolute).

## Accuracy Constraints

- Center error target: no regression beyond `+0.01 px` mean on standard synth gate versus baseline.
- Decode success rate: no precision/recall regression worse than `-0.005` absolute.
- Homography reprojection: investigate/escalate if mean self or vs-GT delta exceeds `+0.02 px`.

## Performance Constraints

- Latency budget: no material end-to-end regression; investigate/escalate if key runs regress by more than `+5%`.
- Allocation limits: avoid introducing additional per-marker overhead in hot lookup paths.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Source evidence: `.ai/state/sessions/2026-02-16-lead-code-quality-audit.md` (Findings 6 and 7).
- This is API-impacting. If mutability/error-contract decisions are hard to reverse, capture in ADR before full integration.
- Given current project stage (`v0.1.x`), targeted API cleanup is acceptable when it materially improves invariants and diagnosability.
