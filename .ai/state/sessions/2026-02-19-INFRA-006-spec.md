# Task: INFRA-006: Split Outer-Fit Responsibilities and Remove Hardcoded Solver Knobs

- **Type:** infra
- **Priority:** P2
- **Requesting role:** Project Lead
- **Assigned workflow:** feature-development

## Problem Statement

`crates/ringgrid/src/detector/outer_fit.rs` currently mixes multiple concerns in one module: local edge sampling, ellipse fitting, decode coupling, candidate scoring, and completion-specific policy branching. It also contains hardcoded outer-ellipse solver knobs (`RansacConfig`) that should come from a shared configuration source rather than local literals.

This task decomposes outer-fit responsibilities into focused units and consolidates solver thresholds/iterations under the detector configuration contract.

## Affected Pipeline Stages

Which of the 10 stages are impacted? List by number and name.

1. [ ] Proposal
2. [x] Outer Estimate
3. [x] Outer Fit
4. [x] Decode
5. [ ] Inner Fit
6. [ ] Dedup
7. [ ] Projective Center (once per marker)
8. [ ] Global Filter
9. [x] Completion (+ projective center for new markers)
10. [ ] Final H Refit

## Affected Modules

List file paths under `crates/ringgrid/src/`:

- `crates/ringgrid/src/detector/outer_fit.rs`
- `crates/ringgrid/src/detector/config.rs`
- `crates/ringgrid/src/detector/mod.rs` (if module split introduces additional internal modules)
- `crates/ringgrid/src/pipeline/fit_decode.rs` (if call-site signatures or imports change)
- `crates/ringgrid/src/detector/completion.rs` (if completion outer-fit call surface changes)

## Public API Impact

- [ ] No API changes
- [ ] New public types (list them)
- [ ] Changed type signatures (list them)
- [x] New config fields (list them, must have `Default`)
- Outer-fit solver config should be sourced from shared config (for example dedicated outer-fit RANSAC knobs under `DetectConfig`).
- [ ] New `Detector` methods (justify)

## Acceptance Criteria

- [ ] Outer-fit responsibilities are split into focused units/modules (sampling, fit/validation, hypothesis evaluation/scoring, and call-site orchestration are no longer co-located as one large mixed-responsibility flow).
- [ ] Hardcoded outer-fit solver knobs are removed from implementation and sourced from config/default single source of truth.
- [ ] Completion-specific behavior remains explicit without duplicating baseline outer-fit logic.
- [ ] Existing reject-reason semantics and diagnostics remain stable or are intentionally updated with documented rationale.
- [ ] Unit tests cover config sourcing for outer-fit solver knobs and representative behavior parity for baseline/completion entrypoints.
- [ ] `cargo test --workspace --all-features` passes.
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` clean.
- [ ] Synthetic eval metrics remain within thresholds (center-mean delta <= `+0.01 px`; no precision/recall regression > `0.005` absolute).

## Accuracy Constraints

- Center error target: no regression beyond `+0.01 px` mean on standard synth gate versus baseline.
- Decode success rate: no precision/recall regression worse than `-0.005` absolute.
- Homography reprojection: investigate/escalate if mean self or vs-GT delta exceeds `+0.02 px`.

## Performance Constraints

- Latency budget: no material end-to-end regression; investigate/escalate if key runs regress by more than `+5%`.
- Allocation limits: avoid introducing per-candidate allocation churn in outer-fit hot paths.

## Python Tooling Changes

- [x] No Python changes needed
- [ ] New scoring metric in `score_detect.py`
- [ ] New visualization in `viz_detect_debug.py`
- [ ] New synthetic generation option in `gen_synth.py`
- [ ] Other: [describe]

## Notes

- Source evidence: `.ai/state/sessions/2026-02-16-lead-code-quality-audit.md` (Finding 4).
- Keep configuration defaults centralized and avoid mirror structs/adapters unless semantically distinct.
- If API-facing config surface changes are non-trivial, capture migration notes in handoff and ADR if hard to reverse.
