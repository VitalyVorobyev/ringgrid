name: Publish Rust crates (crates.io)

on:
  push:
    tags:
      - "v*"

jobs:
  publish:
    runs-on: ubuntu-latest

    # Needed for OIDC -> crates.io token exchange
    permissions:
      id-token: write
      contents: read

    # Optional but recommended: match this in crates.io Trusted Publisher config
    environment: crates-io

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Verify versions match tag (vX.Y.Z)
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          VER="${TAG#v}"

          MAIN_VER="$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name=="ringgrid") | .version')"

          echo "tag version:   $VER"
          echo "main version:  $MAIN_VER"

          test "$MAIN_VER" = "$VER"

      - name: Guard first release (manual publish required once)
        shell: bash
        run: |
          set -euo pipefail
          # Avoid crates.io API access-policy issues by probing the sparse index
          # entry directly. For crate "ringgrid", index path is ri/ng/ringgrid.
          INDEX_URL="https://index.crates.io/ri/ng/ringgrid"
          STATUS="$(
            curl -sS -L \
              -A "ringgrid-ci/${GITHUB_RUN_ID} (+https://github.com/${GITHUB_REPOSITORY})" \
              -o /tmp/ringgrid-index.json \
              -w '%{http_code}' \
              "${INDEX_URL}"
          )"

          if [ "$STATUS" = "404" ]; then
            echo "::error title=First release requires manual publish::Crate 'ringgrid' does not exist on crates.io yet. Trusted Publishing cannot perform the first publish. Run 'cargo publish -p ringgrid --locked' locally with a scoped token, then use this workflow for subsequent tags."
            exit 1
          fi

          if [ "$STATUS" != "200" ]; then
            echo "::warning title=crates.io index check skipped::Could not verify crate existence from index (HTTP $STATUS). Continuing to publish; cargo will perform final validation."
            cat /tmp/ringgrid-index.json || true
          fi

      - name: Test workspace
        run: cargo test --workspace

      - name: Authenticate to crates.io via Trusted Publishing (OIDC)
        id: cratesio
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish ringgrid
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.cratesio.outputs.token }}
        run: cargo publish -p ringgrid --locked
